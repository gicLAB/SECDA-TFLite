# SECDA-TFLite: A Toolkit for Efficient Development of FPGA-based DNN Accelerators for Edge Inference (Needs Update)

The SECDA-TFLite toolkit leverages the TFLite delegate system to provide a robust and extensible set of utilities for integrating DNN accelerators for any DNN operation supported by TFLite.
Ultimately, this increases hardware accelerator developers' productivity, as they can begin developing and refining their design more quickly.

## Repo Structure
Overview of the repo structure with the important directories presented below:
```
SECDA-TFLite_v1.2/
├── LICENSE
├── README.md
├── WORKSPACE
├── config.json
├── data/
│   ├── inputs/
│   └── models/
├── docs/
├── hardware_automation/
├── scripts/
├── src/
│   ├── benchmark_suite/
│   ├── experimental/
│   ├── secda_apps/
│   ├── secda_delegate_generator/
│   ├── secda_delegates/
│   ├── secda_profilier/
│   ├── secda_tflite/
├── tensorflow/
```

### Python Files
- [X] [`hardware_automation/hw_gen.py`](hardware_automation/hw_gen.py) - This is the main script to generate the hardware accelerator delegate.
  
- [X] [`hardware_automation/hlx_templater/hlx_script_templater.ipynb`](hardware_automation/hlx_templater/hlx_script_templater.ipynb) - This is a Jupyter notebook to generate the HLX script templates for the hardware accelerator.
  
- [X] [`src/secda_delegate_generator/generate_delegate.py`](src/secda_delegate_generator/generate_delegate.py) - This is the main script to generate the SECDA-TFLite delegates based on the template provided in [`src/secda_delegate_generator/templates/`](src/secda_delegate_generator/templates/) directory.
  
- [X] [`src/secda_profilier/hardware_profile_visualiser.ipynb`](src/secda_profilier/hardware_profile_visualiser.ipynb) - This is a Jupyter notebook to visualise the hardware profile generated by the SECDA-TFLite profiler.
  
- [X] [`src/secda_profilier/simulation_profile_visualiser.ipynb`](src/secda_profilier/simulation_profile_visualiser.ipynb) - This is a Jupyter notebook to visualise the simulation profile generated by the SECDA-TFLite profiler.
  
- [X] [`src/benchmark_suite/secda_benchmarking_suite.ipynb`](src/benchmark_suite/secda_benchmarking_suite.ipynb) - This is a Jupyter notebook to benchmark the SECDA-TFLite delegates and accelerators.
  


## Installation


### 0. Requirements and Recommendations
---
- Debian-based linux distro (highlighy recommended)
  - Install [docker for linux](https://docs.docker.com/engine/install/ubuntu/)
  - Install git: ```sudo apt install git```
- Otherwise, if using Windows:
   - Install WSL for windows and use Ubuntu 22.04
   - Install [docker for windows](https://docs.docker.com/desktop/setup/install/windows-install/)
- Install [VSCode](https://code.visualstudio.com/download) (highlighy recommended)
   - Install [Dev Containers extension](https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-containers)
 - Hardware Synthesis (Not required for simulation but recommended for updating simulation timing using HLS):
   - Vivado 2019.2 (required for SystemC HLS)
   - Vitis 2024.2 (for logic synthesis for KV260)


### 1. Setup repo #TODO: Update paths
---
Make sure you are in linux-based workspace environment with git installed.
```bash
git clone git@github.com:judeharis/SECDA-TFLite.git
cd SECDA-TFLite
git checkout v1.3
git submodule init
git submodule update
cd scripts
./create_symlink.sh # you might have to make this script executetable "chmod +x ./create_symlink.sh
cd ../tensorflow 
git checkout secda-tflite-v2_prerelease
sudo apt install -y jq
```




You can now set up the dev environment using docker container (recommended) or natively.

## 2.A: Using VSCode Dev Container
- Ensure docker is up and running and current user is part of docker group
  - ``` sudo usermod -aG docker $USER ```
- Install "Dev Containers" extension https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-containers
- Reload the workspace
- These following pop-up should appear
  
![alt text](docs/image-1.png)
- Press Reopen in Container
- It should take a while to download and install the container.
- Once the container is created it should reopen you into the VSCode with the container active.
- You can access the container through "Dev Containers: Open Folder in Container" VSCode command.
  

## 2.B: Create development environment on natively
### Setup Bazel
```bash
sudo apt install apt-transport-https curl gnupg -y && \
curl -fsSL https://bazel.build/bazel-release.pub.gpg | gpg --dearmor >bazel-archive-keyring.gpg && \
sudo mv bazel-archive-keyring.gpg /usr/share/keyrings && \
echo "deb [arch=amd64 signed-by=/usr/share/keyrings/bazel-archive-keyring.gpg] https://storage.googleapis.com/bazel-apt stable jdk1.8" | sudo tee /etc/apt/sources.list.d/bazel.list && \
sudo apt update && sudo apt install bazel-6.1.0 -y && \
sudo ln -sf /usr/bin/bazel-6.1.0 /usr/bin/bazel6
```

### Setup miniconda environment needed for Tensorflow build process (Working with Ubuntu 22.04) 
```bash
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
bash Miniconda3-latest-Linux-x86_64.sh
source ~/.bashrc
conda config --set auto_activate_base false
conda create -n secda-tflitev2 python -y
conda activate secda-tflitev2
pip install -r requirements.txt
```

###  Configure Tensorflow & Test Bazel build (make sure to activate secda-tflitev2 environment)
```bash
conda activate secda-tflitev2
cd tensorflow
# make sure to set python path to /home/your_user/miniconda3/bin/python3
./configure # make sure say no to clang as the default compiler
bazel build --jobs 1 //tensorflow/lite/examples/systemc:hello_systemc
bazel run //tensorflow/lite/examples/systemc:hello_systemc
```


### Optional
```bash
sudo apt-get -y install gdb
```

Once the environment is created, we recommend using VSCode to immediately start developing. Checkout the VSCode instructions below.


## 3. Post Installation Setup

* To enable all the tools of SECDA-TFLite has access to correct paths, you need to configure the [config.json](./config.json) file.
* This file contains the paths to the various directories and files used by the SECDA-TFLite toolkit.
* You have to update the paths in the `config.json` file to point to the correct directories in your system.
* Please refer to the [config.md](./docs/config.md) file for more information on how to configure the `config.json` file.
  

## 4. VSCode Instructions
* Load VSCode `SECDA-TFLite.code-workspace` using "open workspace from file" option in the VSCode File menu. Note: within the container this workspace will be located at `/working_dir/SECDA-TFLite.code-workspace`.

* Once the VSCode workspace is loaded, you are able to run to the launch configurations through the [Run and Debug](https://code.visualstudio.com/docs/editor/debugging) tab to run the end to end simulation.
* These configurations are stored within '/tensorflow/.vscode/launch.json' (to launch) and /tensorflow/.vscode/task.json (to compile), you can edit these to change the parameters to compile and launch the the end to end simulation.
* There are some configurations already prepared to run the VM,SA and FC-GEMM accelerator with the simulation delegates



# Internal Developer Info
* Accelerator Design source code can be found inside the respective simulation delegate
  * Note: we use the same source files for HLS, we manually define __SYNTHESIS__ before HLS
 



# Paper
Our research paper covers the the SECDA-TFLite toolkit in detail including case studies where we design and integrate new DNN accelerator using our toolkit. If you are using the SECDA-TFLite toolkit in research, we kindly request a reference to the following:

```
@article{Haris2023JPDC,
    title = {SECDA-TFLite: A toolkit for efficient development of FPGA-based DNN accelerators for edge inference},
    author = {Jude Haris and Perry Gibson and José Cano and Nicolas {Bohm Agostini} and David Kaeli},
    journal = {Journal of Parallel and Distributed Computing},
    volume = {173},
    pages = {140-151},
    year = {2023},
    issn = {0743-7315},
    doi = {https://doi.org/10.1016/j.jpdc.2022.11.005},
    url = {https://www.sciencedirect.com/science/article/pii/S0743731522002301}
}
```


# Accelerator Designs
* We provide pre-compiled binaries/bitstream for the PYNQ Z1 along with archived Vivado and Vivado HLS project folders ([release](https://github.com/gicLAB/SECDA-TFLite/releases/tag/v1.0)) to enable synthesis from scratch.
* We also provide source code for all accelerators
* For more information please check out the [accelerator source-code](secda_tflite_accel)

## Synthesis for PYNQ-Z1
To perform logic synthesis, we provide Vivado project folders ([release](https://github.com/gicLAB/SECDA-TFLite/releases/tag/v1.0)). These contain the necessary block diagram configuration including AXI DMA's and the accelerators to ensure correct connectivity to the processing system.

**Requirements**
* Vivado HLS 2018.3
* Vivado 2018.3


# Docker Setup for SECDA-TFLite-dev (TF2.7) (Deprecated)
We highly recommend using this container to immediately start developing accelerators and accelerator delegates using the SECDA-TFLite toolkit.

**Requirements**
* Docker
* VSCode
* jq
* gdb

**Instructions**
* First pull the docker image: 
```
docker pull judeharis97/secda-tflite-toolkit:v1
```
* Simply create a container of the downloaded image using the following command: 
```
docker run -it -d --name secda-tflite judeharis97/secda-tflite-toolkit:v1
```

* Once the container is created and launched, you can access it through [VSCode's attach to container functionality](https://code.visualstudio.com/docs/remote/attach-container)
* Load VSCode workspace at `/root/Workspace/tensorflow/tensorflow.code-workspace` using "open workspace from file" option in the VSCode File menu.
* Once the VSCode workspace is loaded, you are able to run to the launch configurations through the [Run and Debug](https://code.visualstudio.com/docs/editor/debugging) tab to run the end to end simulation.
* These configurations are stored within '/root/Workspace/tensorflow/.vscode/launch.json' (to launch) and /root/Workspace/tensorflow/.vscode/task.json (to compile), you can edit these to change the parameters to compile and launch the end to end simulation.
* There is three configuration already prepared to run the VM,SA and FC-GEMM accelerator with the simulation delegates
